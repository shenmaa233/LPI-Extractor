<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>爬取进度 - 激光物理论文参数提取系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        .paper-card {
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .paper-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .paper-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-pending {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        .status-downloading {
            background-color: #ffc107;
        }
        .status-completed {
            background-color: #28a745;
        }
        .status-skipped {
            background-color: #6c757d;
        }
        .status-error {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">激光物理论文参数提取系统</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="bi bi-house-door"></i> 首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/search"><i class="bi bi-search"></i> 论文搜索</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/papers"><i class="bi bi-journals"></i> 论文库</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/parameters"><i class="bi bi-list-ul"></i> 参数数据</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/upload"><i class="bi bi-upload"></i> 上传论文</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/search">论文搜索</a></li>
                        <li class="breadcrumb-item active">爬取进度</li>
                    </ol>
                </nav>
                <h1 class="mb-4"><i class="bi bi-cloud-download"></i> 论文爬取进度</h1>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">爬取状态</h5>
                        <span id="status-badge" class="badge bg-info">正在爬取</span>
                    </div>
                    <div class="card-body">
                        <div class="progress mb-3" style="height: 25px;">
                            <div id="progress-bar" 
                                 class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: '{{ progress.percent_complete|default(0) }}%'" 
                                 aria-valuenow="{{ progress.percent_complete|default(0) }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ progress.percent_complete|default(0) }}%
                            </div>
                        </div>
                        
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h3 id="total-count">{{ progress.total|default(0) }}</h3>
                                        <p class="text-muted">总论文数</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h3 id="processed-count">{{ progress.processed|default(0) }}</h3>
                                        <p class="text-muted">已处理</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h3 id="skipped-count">{{ progress.skipped|default(0) }}</h3>
                                        <p class="text-muted">已跳过（重复）</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h3 id="completed-count">{{ progress.completed|default(0) }}</h3>
                                        <p class="text-muted">已完成</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3" id="status-message">
                            {% if progress.status == 'completed' %}
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle"></i> 爬取任务已完成，共下载 {{ progress.completed }} 篇论文。
                                </div>
                            {% elif progress.status == 'imported' %}
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle"></i> 爬取完成并已导入数据库，共导入 {{ progress.imported_count|default(progress.completed) }} 篇论文。
                                    <div class="mt-2">
                                        <a href="/papers" class="btn btn-sm btn-outline-success">
                                            <i class="bi bi-journals"></i> 查看论文库
                                        </a>
                                    </div>
                                </div>
                            {% elif progress.status == 'failed' %}
                                <div class="alert alert-danger">
                                    <i class="bi bi-exclamation-triangle"></i> 爬取任务失败: {{ progress.error }}
                                </div>
                            {% elif progress.status == 'import_failed' %}
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle"></i> 爬取完成但导入数据库失败: {{ progress.error }}
                                    <div class="mt-2">
                                        <a href="/search" class="btn btn-sm btn-outline-warning">
                                            <i class="bi bi-arrow-counterclockwise"></i> 重新尝试
                                        </a>
                                    </div>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> 正在爬取论文，请稍候...
                                    <span id="current-paper-info">
                                        {% if progress.current_paper %}
                                            当前处理: {{ progress.current_paper.title|truncate(60) }}
                                        {% endif %}
                                    </span>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="mt-3 d-flex justify-content-between">
                            <a href="/search" class="btn btn-outline-primary">
                                <i class="bi bi-arrow-left"></i> 返回搜索
                            </a>
                            
                            <a href="/papers" class="btn btn-outline-success">
                                <i class="bi bi-journals"></i> 查看论文库
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">找到的论文 ({{ papers|length }})</h5>
                    </div>
                    <div class="card-body">
                        {% if papers %}
                            <div class="row" id="papers-container">
                                {% for paper in papers %}
                                    <div class="col-md-6">
                                        <div class="card paper-card" id="paper-{{ paper.id }}">
                                            <div class="card-body">
                                                <h5 class="card-title">
                                                    <span class="paper-status status-pending" 
                                                          data-paper-id="{{ paper.id }}"></span>
                                                    {{ paper.title }}
                                                </h5>
                                                <p class="card-text text-muted">
                                                    {{ paper.authors|join(', ')|truncate(100) }}
                                                </p>
                                                <div class="d-flex justify-content-between">
                                                    <span class="badge bg-secondary">{{ paper.categories|join(', ') }}</span>
                                                    <small class="text-muted">{{ paper.published|truncate(10) }}</small>
                                                </div>
                                                {% if paper.already_exists %}
                                                <div class="mt-2">
                                                    <span class="badge bg-secondary">
                                                        <i class="bi bi-check-circle-fill"></i> 数据库中已存在，已跳过
                                                    </span>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 正在搜索论文，请稍候...
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-light py-4 mt-auto">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-0">激光物理论文参数提取系统</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">基于 DeepSeek API 和 arXiv 构建</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 轮询间隔（毫秒）
        const POLL_INTERVAL = 2000;
        let isCompleted = false;
        
        // 状态映射
        const statusMap = {
            'starting': { text: '初始化中', badge: 'bg-info' },
            'in_progress': { text: '正在爬取', badge: 'bg-primary' },
            'completed': { text: '爬取完成', badge: 'bg-success' },
            'imported': { text: '导入完成', badge: 'bg-success' },
            'failed': { text: '爬取失败', badge: 'bg-danger' },
            'import_failed': { text: '导入失败', badge: 'bg-warning' }
        };
        
        // 更新进度UI
        function updateProgress(data) {
            // 更新进度条
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${data.percent_complete}%`;
            progressBar.textContent = `${data.percent_complete}%`;
            progressBar.setAttribute('aria-valuenow', data.percent_complete);
            
            // 更新计数器
            document.getElementById('total-count').textContent = data.total || 0;
            document.getElementById('processed-count').textContent = data.processed || 0;
            document.getElementById('skipped-count').textContent = data.skipped || 0;
            document.getElementById('completed-count').textContent = data.completed || 0;
            
            // 更新状态
            const statusBadge = document.getElementById('status-badge');
            const status = data.status || 'in_progress';
            const statusInfo = statusMap[status] || { text: '未知', badge: 'bg-secondary' };
            
            statusBadge.textContent = statusInfo.text;
            statusBadge.className = `badge ${statusInfo.badge}`;
            
            // 更新当前论文信息
            const currentPaperInfo = document.getElementById('current-paper-info');
            if (data.current_paper) {
                currentPaperInfo.textContent = `当前处理: ${data.current_paper.title.substring(0, 60)}${data.current_paper.title.length > 60 ? '...' : ''}`;
            }
            
            // 更新状态消息
            const statusMessage = document.getElementById('status-message');
            if (status === 'completed') {
                statusMessage.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> 爬取任务已完成，共下载 ${data.completed} 篇论文。
                    </div>
                `;
                isCompleted = true;
            } else if (status === 'imported') {
                statusMessage.innerHTML = `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> 爬取完成并已导入数据库，共导入 ${data.imported_count || data.completed} 篇论文。
                        <div class="mt-2">
                            <a href="/papers" class="btn btn-sm btn-outline-success">
                                <i class="bi bi-journals"></i> 查看论文库
                            </a>
                        </div>
                    </div>
                `;
                isCompleted = true;
            } else if (status === 'failed') {
                statusMessage.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> 爬取任务失败: ${data.error || '未知错误'}
                    </div>
                `;
                isCompleted = true;
            } else if (status === 'import_failed') {
                statusMessage.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 爬取完成但导入数据库失败: ${data.error || '未知错误'}
                        <div class="mt-2">
                            <a href="/search" class="btn btn-sm btn-outline-warning">
                                <i class="bi bi-arrow-counterclockwise"></i> 重新尝试
                            </a>
                        </div>
                    </div>
                `;
                isCompleted = true;
            } else {
                statusMessage.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 正在爬取论文，请稍候...
                        <span id="current-paper-info">
                            ${data.current_paper ? `当前处理: ${data.current_paper.title.substring(0, 60)}${data.current_paper.title.length > 60 ? '...' : ''}` : ''}
                        </span>
                    </div>
                `;
            }
            
            // 停止轮询
            if (isCompleted) {
                clearInterval(pollInterval);
            }
        }
        
        // 轮询进度
        function pollProgress() {
            fetch('/api/crawler_progress/{{ output_dir }}')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    updateProgress(data);
                })
                .catch(error => {
                    console.error('获取进度失败:', error);
                });
        }
        
        // 页面加载时执行一次
        document.addEventListener('DOMContentLoaded', function() {
            // 设置状态
            const initialStatus = '{{ progress.status }}' || 'in_progress';
            if (initialStatus === 'completed' || initialStatus === 'imported' || 
                initialStatus === 'failed' || initialStatus === 'import_failed') {
                isCompleted = true;
            }
            
            // 如果没有完成，开始轮询
            if (!isCompleted) {
                pollProgress();
                window.pollInterval = setInterval(pollProgress, POLL_INTERVAL);
            }
        });
    </script>
</body>
</html> 